using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Serilog;
using System.Collections.ObjectModel;
using System.Net.Http;
using System.Net.Http.Json;
using System.Diagnostics;
using System.IO;
using Client;
using System.Collections.Specialized;
using System.ComponentModel;
using System.Linq;
using System.Collections.Generic;
using System;

namespace Client;

public partial class ClientViewModel : ObservableObject
{
    public ObservableCollection<string> Events { get; } = new();
    public ObservableCollection<TargetClient> ConnectedClients { get; } = new();

    [ObservableProperty]
    private string connectionStatus = "Disconnected";

    [ObservableProperty]
    private string? syncDirectory;

    // Settings fields shown in the window
    [ObservableProperty]
    private string? clientId;

    [ObservableProperty]
    private string serverUrl = "http://*:2665/hub";

    [ObservableProperty]
    private string? resultCallback;

    [ObservableProperty]
    private double? mouseMoveHz;

    [ObservableProperty]
    private bool startAsController;

    [ObservableProperty]
    private bool overwriteExistingOnly = true;

    [ObservableProperty]
    private bool syncEnabled = false;

    [ObservableProperty]
    private string syncStatusText = "Sync disabled";

    [ObservableProperty]
    private bool isController;

    [ObservableProperty]
    private string? currentControllerId;

    [ObservableProperty]
    private string controlButtonText = "Request Control";

    [ObservableProperty]
    private string controllerStatusText = "No controller";

    [ObservableProperty]
    private bool hasController;

    partial void OnIsControllerChanged(bool value)
    {
        ControlButtonText = value ? "Release Control" : "Request Control";
        UpdateControllerStatus();
    }

    partial void OnCurrentControllerIdChanged(string? value)
    {
        HasController = !string.IsNullOrWhiteSpace(value);
        UpdateControllerStatus();
    }

    private void UpdateControllerStatus()
    {
        if (IsController)
            ControllerStatusText = "You are the controller";
        else if (!string.IsNullOrWhiteSpace(CurrentControllerId))
            ControllerStatusText = $"Controller: {CurrentControllerId}";
        else
            ControllerStatusText = "No controller";
    }

    [RelayCommand]
    public void AddEvent(string message)
    {
        if (App.Current?.Dispatcher != null)
            App.Current.Dispatcher.Invoke(() => Events.Add(message));
        else
            Events.Add(message);
    }

    [RelayCommand]
    private void ClearEvents()
    {
        if (App.Current?.Dispatcher != null)
            App.Current.Dispatcher.Invoke(() => Events.Clear());
        else
            Events.Clear();
    }

    private readonly FileSyncManager? _fileSync;
    public ClientViewModel()
    {
        ConnectedClients.CollectionChanged += ConnectedClients_CollectionChanged;
    }
    public ClientViewModel(FileSyncManager fileSync) : this()
    {
        _fileSync = fileSync;
    }

    private void ConnectedClients_CollectionChanged(object? sender, NotifyCollectionChangedEventArgs e)
    {
        if (e.NewItems != null)
        {
            foreach (var item in e.NewItems)
            {
                if (item is TargetClient tc)
                {
                    tc.PropertyChanged += TargetClient_PropertyChanged;
                }
            }
        }
        if (e.OldItems != null)
        {
            foreach (var item in e.OldItems)
            {
                if (item is TargetClient tc)
                {
                    tc.PropertyChanged -= TargetClient_PropertyChanged;
                }
            }
        }
    }

    private void TargetClient_PropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(TargetClient.IsSelected))
            SaveSelectedTargets();
    }

    public void LoadPreferencesIfAvailable()
    {
        try
        {
            var prefs = ClientPrefs.Load();
            if (prefs != null)
            {
                ClientId = prefs.ClientId;
                ServerUrl = string.IsNullOrWhiteSpace(prefs.ServerUrl) ? ServerUrl : prefs.ServerUrl;
                ResultCallback = prefs.ResultCallback;
                SyncDirectory = prefs.SyncDirectory;
                StartAsController = prefs.Controller;
                MouseMoveHz = prefs.MouseMoveHz;
                OverwriteExistingOnly = prefs.OverwriteExistingOnly;
                SyncEnabled = prefs.SyncEnabled;
                SyncStatusText = SyncEnabled ? "Sync enabled" : "Sync disabled";
                AddEvent($"Preferences loaded for {ClientId ?? "<unknown>"}");
            }
            else
            {
                // Fall back to current runtime settings if present
                ClientId = ClientWorker.Settings.ClientId;
                ServerUrl = ClientWorker.Settings.ServerUrl ?? ServerUrl;
                ResultCallback = ClientWorker.Settings.ResultCallback;
                SyncDirectory = ClientWorker.Settings.SyncDirectory;
                StartAsController = ClientWorker.Settings.Controller;
                MouseMoveHz = ClientWorker.Settings.MouseMoveHz;
                OverwriteExistingOnly = ClientWorker.Settings.OverwriteExistingOnly;
                SyncEnabled = ClientWorker.Settings.SyncEnabled;
                SyncStatusText = SyncEnabled ? "Sync enabled" : "Sync disabled";
            }
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to load preferences");
        }
    }

    partial void OnOverwriteExistingOnlyChanged(bool value)
    {
        try
        {
            ClientWorker.Settings.OverwriteExistingOnly = value;
            ClientPrefs.Save(new ClientSettings
            {
                ClientId = ClientWorker.Settings.ClientId,
                ServerUrl = ClientWorker.Settings.ServerUrl,
                ResultCallback = ClientWorker.Settings.ResultCallback,
                SyncDirectory = ClientWorker.Settings.SyncDirectory ?? SyncDirectory,
                Controller = ClientWorker.Settings.Controller,
                MouseMoveHz = ClientWorker.Settings.MouseMoveHz,
                OverwriteExistingOnly = value
            });
            AddEvent($"Sync mode: {(value ? "Overwrite existing only" : "Standard apply")}" );
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to persist OverwriteExistingOnly");
        }
    }

    [RelayCommand]
    private async Task SaveSyncDirectory()
    {
        if (string.IsNullOrWhiteSpace(SyncDirectory)) return;
        if (SyncEnabled)
        {
            _fileSync?.SetDirectory(SyncDirectory!);
            AddEvent($"Sync dir set: {SyncDirectory}");
        }
        else
        {
            _fileSync?.SetDirectoryNoWatch(SyncDirectory!);
            AddEvent($"Sync dir saved (disabled): {SyncDirectory}");
        }
        await Task.CompletedTask;
    }

    [RelayCommand]
    private async Task PushInitialSync()
    {
        if (string.IsNullOrWhiteSpace(SyncDirectory) || _fileSync == null) return;
        await _fileSync.PushInitialAsync();
        AddEvent("Initial sync pushed");
    }

    [RelayCommand]
    private async Task RequestControl()
    {
        try
        {
            var baseHttp = ClientWorker.BaseFromHubUrl(ClientWorker.Settings.ServerUrl);
            var http = new HttpClient();

            // First, check current controller
            var getUrl = new Uri(new Uri(baseHttp), "/api/sync/controller");
            var getResp = await http.GetAsync(getUrl);
            if (getResp.IsSuccessStatusCode)
            {
                var json = await getResp.Content.ReadAsStringAsync();
                // naive parse: look for controller value
                var controllerVal = System.Text.Json.JsonDocument.Parse(json).RootElement.GetProperty("controller").GetString();
                CurrentControllerId = controllerVal;
                if (!string.IsNullOrWhiteSpace(controllerVal) && !string.Equals(controllerVal, ClientWorker.Settings.ClientId, StringComparison.OrdinalIgnoreCase))
                {
                    AddEvent($"Controller in use by {controllerVal}");
                    return;
                }
            }

            // Toggle control state
            var target = IsController ? "none" : (ClientWorker.Settings.ClientId ?? Environment.MachineName);
            var postUrl = new Uri(new Uri(baseHttp), $"/api/sync/controller/{target}");
            var resp = await http.PostAsync(postUrl, null);
            AddEvent(IsController ? $"Released control: {(int)resp.StatusCode}" : $"Requested control: {(int)resp.StatusCode}");
        }
        catch (Exception ex)
        {
            Log.Warning(ex, "Request control failed");
        }
    }

    [ObservableProperty]
    private string? runCommandPath;

    [ObservableProperty]
    private string? runCommandArgs;

    [RelayCommand]
    private async Task RefreshClients()
    {
        try
        {
            var baseHttp = ClientWorker.BaseFromHubUrl(ClientWorker.Settings.ServerUrl);
            var http = new HttpClient();
            var url = new Uri(new Uri(baseHttp), "/api/clients/connected");
            var resp = await http.GetAsync(url);
            if (!resp.IsSuccessStatusCode)
            {
                AddEvent($"Refresh clients failed: {(int)resp.StatusCode}");
                return;
            }
            var json = await resp.Content.ReadAsStringAsync();
            var arr = System.Text.Json.JsonDocument.Parse(json).RootElement;
            var newIds = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            var persisted = ClientPrefs.Load();
            var selectedIds = (ClientWorker.Settings.SelectedTargets ?? persisted?.SelectedTargets) ?? new List<string>();
            if (arr.ValueKind == System.Text.Json.JsonValueKind.Array)
            {
                foreach (var el in arr.EnumerateArray())
                {
                    var id = el.GetString() ?? string.Empty;
                    if (string.IsNullOrWhiteSpace(id)) continue;
                    newIds.Add(id);
                }
                // Apply on UI thread
                var apply = () =>
                {
                    // Add/update
                    foreach (var id in newIds)
                    {
                        var existing = ConnectedClients.FirstOrDefault(c => string.Equals(c.Id, id, StringComparison.OrdinalIgnoreCase));
                        if (existing == null)
                        {
                            var selected = selectedIds.Any(s => string.Equals(s, id, StringComparison.OrdinalIgnoreCase));
                            var tc = new TargetClient(id, selected);
                            ConnectedClients.Add(tc);
                        }
                        else
                        {
                            var shouldBeSelected = selectedIds.Any(s => string.Equals(s, id, StringComparison.OrdinalIgnoreCase));
                            if (existing.IsSelected != shouldBeSelected)
                                existing.IsSelected = shouldBeSelected;
                        }
                    }
                    // Remove stale
                    for (int i = ConnectedClients.Count - 1; i >= 0; i--)
                    {
                        if (!newIds.Contains(ConnectedClients[i].Id))
                        {
                            ConnectedClients.RemoveAt(i);
                        }
                    }
                };
                if (App.Current?.Dispatcher != null)
                    App.Current.Dispatcher.Invoke(apply);
                else
                    apply();
            }
            AddEvent($"Clients refreshed: {ConnectedClients.Count}");
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to refresh clients");
        }
    }

    [RelayCommand]
    private async Task SendRunCommand()
    {
        try
        {
            var targets = ConnectedClients.Where(c => c.IsSelected).Select(c => c.Id).ToArray();
            if (targets.Length == 0)
            {
                AddEvent("No target clients selected");
                return;
            }
            if (string.IsNullOrWhiteSpace(RunCommandPath))
            {
                AddEvent("Command path is empty");
                return;
            }
            var baseHttp = ClientWorker.BaseFromHubUrl(ClientWorker.Settings.ServerUrl);
            var http = new HttpClient();
            var args = string.IsNullOrWhiteSpace(RunCommandArgs) ? null : RunCommandArgs!.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            var req = new Shared.RunCommandRequest(RunCommandPath!, args);
            int ok = 0;
            foreach (var t in targets)
            {
                var url = new Uri(new Uri(baseHttp), $"/api/commands/run-cmd?targetClientId={Uri.EscapeDataString(t)}");
                var resp = await http.PostAsJsonAsync(url, req);
                if (resp.IsSuccessStatusCode) ok++;
                AddEvent($"RunCommand to {t}: {(int)resp.StatusCode}");
            }
            SaveSelectedTargets();
            AddEvent($"RunCommand sent. Success: {ok}/{targets.Length}");
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to send RunCommand");
        }
    }

    [RelayCommand]
    private void SelectAllClients()
    {
        foreach (var c in ConnectedClients) c.IsSelected = true;
        SaveSelectedTargets();
    }

    [RelayCommand]
    private void SelectNoneClients()
    {
        foreach (var c in ConnectedClients) c.IsSelected = false;
        SaveSelectedTargets();
    }

    [ObservableProperty]
    private string? serviceName;

    [ObservableProperty]
    private string? serviceParams;

    [RelayCommand]
    private async Task SendServiceRun()
    {
        try
        {
            var targets = ConnectedClients.Where(c => c.IsSelected).Select(c => c.Id).ToArray();
            if (targets.Length == 0)
            {
                AddEvent("No target clients selected");
                return;
            }
            if (string.IsNullOrWhiteSpace(ServiceName))
            {
                AddEvent("Service name is empty");
                return;
            }

            var baseHttp = ClientWorker.BaseFromHubUrl(ClientWorker.Settings.ServerUrl);
            var http = new HttpClient();
            var correlation = Guid.NewGuid().ToString("N");

            Dictionary<string, string>? parameters = null;
            if (!string.IsNullOrWhiteSpace(ServiceParams))
            {
                parameters = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
                var entries = ServiceParams!
                    .Split(new[] { ';', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
                foreach (var entryRaw in entries)
                {
                    var entry = entryRaw.Trim();
                    if (entry.Length == 0) continue;
                    var idx = entry.IndexOf('=');
                    if (idx < 0) idx = entry.IndexOf(':');
                    if (idx > 0)
                    {
                        var key = entry.Substring(0, idx).Trim();
                        var value = entry.Substring(idx + 1).Trim();
                        if (!string.IsNullOrWhiteSpace(key))
                            parameters[key] = value;
                    }
                }
                if (parameters.Count == 0) parameters = null;
            }

            var req = new Shared.RunServiceRequest(ServiceName!, correlation, parameters);
            int ok = 0;
            foreach (var t in targets)
            {
                var url = new Uri(new Uri(baseHttp), $"/api/tasks/service-run?targetClientId={Uri.EscapeDataString(t)}");
                var resp = await http.PostAsJsonAsync(url, req);
                if (resp.IsSuccessStatusCode) ok++;
                AddEvent($"ServiceRun '{ServiceName}' to {t}: {(int)resp.StatusCode} (corr={correlation})");
            }
            SaveSelectedTargets();
            AddEvent($"ServiceRun sent. Success: {ok}/{targets.Length} (corr={correlation})");
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to send ServiceRun");
        }
    }

    private void SaveSelectedTargets()
    {
        try
        {
            var selected = ConnectedClients.Where(c => c.IsSelected).Select(c => c.Id).Distinct(StringComparer.OrdinalIgnoreCase).ToList();
            ClientWorker.Settings.SelectedTargets = selected;
            ClientPrefs.Save(new ClientSettings
            {
                ClientId = ClientWorker.Settings.ClientId,
                ServerUrl = ClientWorker.Settings.ServerUrl,
                ResultCallback = ClientWorker.Settings.ResultCallback,
                SyncDirectory = ClientWorker.Settings.SyncDirectory ?? SyncDirectory,
                SyncEnabled = ClientWorker.Settings.SyncEnabled,
                Controller = ClientWorker.Settings.Controller,
                MouseMoveHz = ClientWorker.Settings.MouseMoveHz,
                OverwriteExistingOnly = ClientWorker.Settings.OverwriteExistingOnly,
                SelectedTargets = selected
            });
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to persist selected targets");
        }
    }

    [RelayCommand]
    private async Task OpenSyncDirectory()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(SyncDirectory))
            {
                AddEvent("No sync directory set");
                return;
            }
            if (!Directory.Exists(SyncDirectory))
            {
                Directory.CreateDirectory(SyncDirectory);
            }
            var psi = new ProcessStartInfo
            {
                FileName = SyncDirectory,
                UseShellExecute = true
            };
            Process.Start(psi);
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to open sync directory");
        }
    }

    partial void OnSyncEnabledChanged(bool value)
    {
        try
        {
            ClientWorker.Settings.SyncEnabled = value;
            if (value)
            {
                // Start watching if we have a directory
                if (!string.IsNullOrWhiteSpace(SyncDirectory))
                    _fileSync?.SetDirectory(SyncDirectory!);
                else
                    AddEvent("Sync enabled, but no directory set");
                SyncStatusText = "Sync enabled";
            }
            else
            {
                _fileSync?.StopWatching();
                SyncStatusText = "Sync disabled";
            }

            ClientPrefs.Save(new ClientSettings
            {
                ClientId = ClientWorker.Settings.ClientId,
                ServerUrl = ClientWorker.Settings.ServerUrl,
                ResultCallback = ClientWorker.Settings.ResultCallback,
                SyncDirectory = ClientWorker.Settings.SyncDirectory ?? SyncDirectory,
                SyncEnabled = value,
                Controller = ClientWorker.Settings.Controller,
                MouseMoveHz = ClientWorker.Settings.MouseMoveHz,
                OverwriteExistingOnly = ClientWorker.Settings.OverwriteExistingOnly
            });
            AddEvent(value ? "File sync enabled" : "File sync disabled");
        }
        catch (Exception ex)
        {
            Serilog.Log.Warning(ex, "Failed to toggle SyncEnabled");
        }
    }
}


